name: pipeline

on:
  push:
    branches:
      - develop
      - internal/*
      - external/*

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - run: mvn test  
    - name: Generate JaCoCo Badge
      id: jacoco
      uses: cicirello/jacoco-badge-generator@v2.11.0
    - name: Log coverage percentage
      run: |
        echo "coverage = ${{ steps.jacoco.outputs.coverage }}"
        echo "branch coverage = ${{ steps.jacoco.outputs.branches }}"    
    - name: Upload JaCoCo coverage report
      uses: actions/upload-artifact@v2
      with:
        name: jacoco-report
        path: target/site/jacoco/

  build:
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    
    - name: Package
      run: mvn package  

  deploy-STG:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: stg
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: Deploy to STG
        shell: bash
        run: |
          echo "Deploying to STG environment"

  deploy-Internal:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/heads/internal/')
    steps:
      - name: Deploy to Internal Resource
        shell: bash
        run: |
          echo "Deploying to Internal Resource based on internal branch strategy"
          

  deploy-External:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/heads/external/')
    steps:
      - name: Notify internal team for evaluation
        run: |
          echo "Notifying internal team for evaluation of branch ${{ github.ref }}"
          # Aqui você pode integrar com uma ferramenta de comunicação como Slack ou Email para notificação

      - name: Wait for approval
        id: approval
        uses: peter-evans/wait-for-approval@v1
        with:
          approvers: user1,user2,user3  # Substitua pelos usuários que podem aprovar
          # opcional: Adicione uma mensagem personalizada e tempo de espera máximo

      - name: Deploy to External Resource
        if: steps.approval.outputs.approved == 'true'
        shell: bash
        run: |
          echo "Deploying to External Resource based on external branch strategy"
          

      - name: Handle approval rejection
        if: steps.approval.outputs.approved != 'true'
        run: |
          echo "Deployment "rejected" by internal team bruno"
          exit 1
